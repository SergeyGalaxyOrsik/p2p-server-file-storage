### **Техническое задание на разработку P2P файлового хранилища**

**1. Общие положения**

*   **Наименование проекта:** Распределённое P2P файловое хранилище «CourseStore».
*   **Основание для разработки:** Учебный проект в рамках курсовой работы.
*   **Цель проекта:** Разработка прототипа распределённого файлового хранилища, использующего гибридную P2P-архитектуру, с обязательным применением WinAPI для ключевых системных функций.

**2. Назначение и цели**

*   **Назначение системы:** Программный комплекс предназначен для хранения файлов путём их разделения на фрагменты (чанки) и распределённого хранения этих фрагментов на нескольких узлах (компьютерах) в сети с возможностью последующего восстановления.
*   **Основные цели:**
    1.  Изучить и применить на практике принципы построения распределённых систем.
    2.  Получить опыт работы с системным программированием под Windows с использованием WinAPI и сетевым программированием с Winsock.
    3.  Создать работающий прототип системы, состоящий из трёх ключевых компонентов: клиента, узла хранения и сервера метаданных.
    4.  Реализовать базовую отказоустойчивость за счёт репликации данных.

**3. Требования к системе**

**3.1. Состав системы**

Система должна состоять из трёх отдельных приложений:

1.  **Сервер метаданных (Metadata Server):** Центральный координирующий узел.
2.  **Узел хранения (Storage Node):** Приложение, работающее на машинах, предоставляющих дисковое пространство.
3.  **Клиент (Client):** Консольная утилита для взаимодействия пользователя с системой.

**3.2. Функциональные требования**

**3.2.1. Сервер метаданных (Metadata Server)**

*   Должен быть реализован как консольное приложение на C++ с использованием Winsock.
*   **Управление узлами:**
    *   Принимать и обрабатывать запросы на регистрацию от новых Узлов хранения.
    *   Хранить в оперативной памяти список активных узлов (IP-адрес, порт, доступное пространство).
    *   Периодически проверять доступность узлов (например, через keep-alive сообщения) и удалять из списка неактивные.
*   **Управление метаданными файлов:**
    *   Принимать от Клиента запросы на загрузку файла. В ответ предоставлять список Узлов для размещения чанков.
    *   Хранить карту файлов: `[Имя файла] -> [Список ID чанков] -> [Список IP-адресов узлов для каждого чанка]`.
    *   Принимать от Клиента запросы на скачивание файла. В ответ предоставлять вышеуказанную карту чанков для этого файла.
*   **Хранение метаданных:** Для курсовой работы достаточно хранения метаданных в оперативной памяти. *(Бонусный пункт: реализация сохранения и загрузки состояния в файл, например, в формате JSON, при запуске/завершении работы сервера).*

**3.2.2. Узел хранения (Storage Node)**

*   Должен быть реализован как консольное приложение на C++ (в идеале — как служба Windows, но для курсовой достаточно консольного приложения).
*   **Инициализация:**
    *   При запуске должен подключаться к Серверу метаданных для регистрации.
    *   Должен определять количество свободного места в выделенной для хранения директории с помощью `GetDiskFreeSpaceEx` (WinAPI).
*   **Работа с чанками:**
    *   Принимать от Клиента команды на сохранение чанка. Чанки сохраняются в локальную папку под уникальными именами (например, их хеш или UUID).
    *   Принимать от Клиента команды на отдачу чанка по его ID.
    *   Использовать функции `CreateFile`, `ReadFile`, `WriteFile` (WinAPI) для работы с файлами.
*   **Сетевое взаимодействие:** Использовать Winsock для прослушивания порта и обмена данными.

**3.2.3. Клиент (Client)**

*   Должен быть реализован как консольная утилита на C++.
*   **Функция загрузки файла (`upload <локальный_путь_к_файлу>`):**
    1.  Обратиться к Серверу метаданных с запросом на загрузку.
    2.  Получить от сервера список Узлов для размещения.
    3.  Разбить исходный файл на чанки фиксированного размера (например, 1 МБ).
    4.  Для каждого чанка создать 2 копии (репликация).
    5.  Подключиться к соответствующим Узлам хранения и отправить им чанки.
    6.  После успешной загрузки всех чанков уведомить Сервер метаданных о завершении.
*   **Функция скачивания файла (`download <имя_файла_в_системе> <локальный_путь_сохранения>`):**
    1.  Обратиться к Серверу метаданных с запросом на скачивание.
    2.  Получить карту расположения чанков файла.
    3.  Параллельно (в несколько потоков) или последовательно скачивать чанки с доступных Узлов хранения.
    4.  Собрать исходный файл из скачанных чанков в правильном порядке.

**3.3. Нефункциональные требования**

*   **Платформа:** Windows 10/11, Windows Server 2016 и новее.
*   **Среда разработки:** Visual Studio.
*   **Язык программирования:** C++.
*   **Ключевые технологии:** WinAPI, Winsock 2.
*   **Протокол взаимодействия:** Разработать простой текстовый или бинарный протокол на основе TCP/IP.
*   **Отказоустойчивость:** Система должна переживать отказ одного Узла хранения без потери файла (за счёт репликации с коэффициентом 2).

**4. Этапы разработки**

1.  **Этап 1: Проектирование (1 неделя)**
    *   Детальная проработка архитектуры.
    *   Разработка сетевого протокола (описание всех команд и форматов сообщений).
2.  **Этап 2: Реализация Сервера метаданных (2 недели)**
    *   Создание базовой структуры.
    *   Реализация логики регистрации узлов и хранения их списка.
    *   Реализация логики обработки запросов от клиента и ведения карты файлов.
3.  **Этап 3: Реализация Узла хранения (2 недели)**
    *   Реализация логики регистрации на сервере.
    *   Реализация сетевого модуля для приёма и отдачи чанков.
    *   Реализация файловых операций.
4.  **Этап 4: Реализация Клиента (2 недели)**
    *   Реализация логики разбиения файла на чанки.
    *   Реализация взаимодействия с сервером и узлами для загрузки файла.
    *   Реализация логики скачивания и сборки файла.
5.  **Этап 5: Тестирование и отладка (1 неделя)**
    *   Проведение интеграционного тестирования всей системы.
    *   Тестирование сценариев отказа (отключение одного из узлов во время скачивания).
6.  **Этап 6: Подготовка документации (1 неделя)**
    *   Написание пояснительной записки к курсовой работе.

**5. Критерии приёмки**

Проект считается успешно выполненным, если:
1.  Реализованы все три компонента системы.
2.  Клиент может успешно загрузить файл размером >10 МБ.
3.  Клиент может успешно скачать этот файл, и его контрольная сумма совпадает с оригиналом.
4.  Система остаётся работоспособной (файл можно скачать), если в процессе работы был отключен один из узлов, на котором хранилась копия чанка.

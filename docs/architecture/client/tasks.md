# Задачи для реализации Client

## Общая информация

Этот документ содержит детальный список задач для реализации Client - консольной утилиты для взаимодействия с системой CourseStore.

**Оценка времени:** ~2 недели (80 часов)

---

## Этап 1: Базовые компоненты и утилиты

### Задача 1.1: Настройка проекта
**Приоритет:** Высокий  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

- [ ] Создать структуру папок:
  - [ ] `client/src/core/`
  - [ ] `client/src/utils/`
  - [ ] `client/include/core/`
  - [ ] `client/include/utils/`
- [ ] Создать `CMakeLists.txt` для client
- [ ] Настроить зависимости (common library)
- [ ] Настроить компиляцию под Windows и Linux

**Критерии приёмки:**
- Проект компилируется без ошибок
- Можно собрать пустой исполняемый файл

---

### Задача 1.2: Реализация HashUtils
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/include/utils/hash_utils.h`
- `client/src/utils/hash_utils.cpp`

**Функциональность:**
- [ ] `CalculateSHA256(data)` - вычисление SHA-256 для данных
- [ ] `CalculateSHA256(filepath)` - вычисление SHA-256 для файла
- [ ] `VerifyHash(data, expectedHash)` - проверка хеша
- [ ] Поддержка Windows (CryptoAPI) и Linux (OpenSSL или встроенная библиотека)
- [ ] Обработка ошибок

**Критерии приёмки:**
- Хеши вычисляются корректно
- Работает на Windows и Linux
- Тесты для основных функций

---

### Задача 1.3: Реализация ChunkProcessor (часть 1 - разбиение файла)
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/include/core/chunk_processor.h`
- `client/src/core/chunk_processor.cpp`

**Функциональность:**
- [ ] Определить структуру `Chunk`
- [ ] `SplitFile(filepath)` - разбиение файла на чанки
  - [ ] Открытие файла через std::ifstream
  - [ ] Чтение по 1 МБ
  - [ ] Вычисление хеша для каждого чанка
  - [ ] Сохранение индекса и размера
- [ ] Использование платформо-независимого std::fstream
- [ ] Обработка ошибок чтения

**Критерии приёмки:**
- Файлы разбиваются корректно
- Хеши вычисляются для каждого чанка
- Работает с файлами любого размера

---

### Задача 1.4: Реализация ChunkProcessor (часть 2 - сборка файла)
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `AssembleFile(chunks, outputPath)` - сборка файла из чанков
  - [ ] Сортировка чанков по индексу
  - [ ] Проверка целостности последовательности
  - [ ] Запись через std::ofstream
  - [ ] Валидация каждого чанка перед записью
- [ ] `ValidateChunk(chunk)` - валидация чанка
  - [ ] Проверка структуры
  - [ ] Проверка хеша
- [ ] Обработка ошибок записи

**Критерии приёмки:**
- Файлы собираются корректно
- Валидация работает
- Проверка последовательности чанков

---

### Задача 1.5: Реализация ProgressReporter
**Приоритет:** Низкий  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/include/utils/progress_reporter.h`
- `client/src/utils/progress_reporter.cpp`

**Функциональность:**
- [ ] `ReportUploadProgress(current, total)` - прогресс загрузки
- [ ] `ReportDownloadProgress(current, total)` - прогресс скачивания
- [ ] `PrintProgressBar(current, total, operation)` - отображение прогресс-бара
- [ ] Форматирование процентов и времени

**Критерии приёмки:**
- Прогресс отображается корректно
- Прогресс-бар работает

---

## Этап 2: Взаимодействие с серверами

### Задача 2.1: Реализация MetadataClient (часть 1 - базовые методы)
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/include/core/metadata_client.h`
- `client/src/core/metadata_client.cpp`

**Функциональность:**
- [ ] Конструктор и деструктор
- [ ] `ConnectToServer(socket)` - подключение к серверу
- [ ] `SendRequest(socket, request)` - отправка запроса
- [ ] `ReceiveResponse(socket, response)` - получение ответа
- [ ] Использование NetworkUtils из common
- [ ] Обработка сетевых ошибок

**Критерии приёмки:**
- Подключение к серверу работает
- Отправка и получение сообщений работает

---

### Задача 2.2: Реализация MetadataClient (часть 2 - загрузка)
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `RequestUploadNodes(filename, size, nodeCount)` - запрос узлов для загрузки
  - [ ] Формирование запроса REQUEST_UPLOAD
  - [ ] Отправка запроса
  - [ ] Получение ответа
  - [ ] Парсинг списка узлов
  - [ ] Создание StorageNodeInfo из ответа
- [ ] `NotifyUploadComplete(filename, chunks)` - уведомление о завершении
  - [ ] Формирование многострочного запроса UPLOAD_COMPLETE
  - [ ] Отправка запроса
  - [ ] Получение ответа
- [ ] Парсинг ответов сервера

**Критерии приёмки:**
- Запрос узлов работает корректно
- Уведомление о завершении работает
- Парсинг ответов корректен

---

### Задача 2.3: Реализация MetadataClient (часть 3 - скачивание и список)
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `RequestDownload(filename)` - запрос метаданных для скачивания
  - [ ] Формирование запроса REQUEST_DOWNLOAD
  - [ ] Отправка и получение ответа
  - [ ] Парсинг многострочного ответа
  - [ ] Создание FileMetadata из ответа
- [ ] `ListFiles()` - список файлов
  - [ ] Формирование запроса LIST_FILES
  - [ ] Отправка и получение ответа
  - [ ] Парсинг списка файлов
- [ ] `TestConnection()` - проверка подключения

**Критерии приёмки:**
- Запрос метаданных работает
- Список файлов работает
- Парсинг многострочных ответов корректен

---

### Задача 2.4: Реализация NodeClient (часть 1 - базовые методы)
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/include/core/node_client.h`
- `client/src/core/node_client.cpp`

**Функциональность:**
- [ ] Конструктор и деструктор
- [ ] `ConnectToNode(node, socket)` - подключение к узлу
- [ ] `SendBinaryData(socket, data)` - отправка бинарных данных
- [ ] `ReceiveBinaryData(socket, data, size)` - получение бинарных данных
- [ ] Обработка таймаутов
- [ ] Обработка сетевых ошибок

**Критерии приёмки:**
- Подключение к узлам работает
- Передача бинарных данных работает

---

### Задача 2.5: Реализация NodeClient (часть 2 - работа с чанками)
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `StoreChunk(node, chunkId, data)` - сохранение чанка
  - [ ] Подключение к узлу
  - [ ] Отправка команды STORE_CHUNK
  - [ ] Отправка бинарных данных
  - [ ] Получение ответа
  - [ ] Проверка успешности
- [ ] `GetChunk(node, chunkId, data)` - получение чанка
  - [ ] Подключение к узлу
  - [ ] Отправка команды GET_CHUNK
  - [ ] Получение ответа с размером
  - [ ] Получение бинарных данных
- [ ] `CheckChunk(node, chunkId)` - проверка наличия чанка
  - [ ] Отправка команды CHECK_CHUNK
  - [ ] Получение ответа

**Критерии приёмки:**
- Сохранение чанков работает
- Получение чанков работает
- Обработка ошибок

---

## Этап 3: Менеджеры загрузки и скачивания

### Задача 3.1: Реализация UploadManager (часть 1 - базовая загрузка)
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/include/core/upload_manager.h`
- `client/src/core/upload_manager.cpp`

**Функциональность:**
- [ ] Конструктор с MetadataClient
- [ ] `UploadFile(localPath, remoteFilename)` - главный метод загрузки
  - [ ] Проверка существования файла
  - [ ] Разбиение файла на чанки
  - [ ] Запрос узлов у Metadata Server
  - [ ] Проверка достаточности узлов
  - [ ] Загрузка чанков
  - [ ] Уведомление о завершении
- [ ] `UploadChunk(chunk, nodes)` - загрузка чанка с репликацией
  - [ ] Загрузка на все узлы (репликация)
  - [ ] Повторные попытки при ошибках
- [ ] Обработка ошибок на каждом этапе

**Критерии приёмки:**
- Загрузка файла работает
- Репликация работает
- Обработка ошибок

---

### Задача 3.2: Реализация UploadManager (часть 2 - оптимизации)
**Приоритет:** Средний  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Параллельная загрузка чанков (опционально)
- [ ] `SelectNodesForChunk(nodes, chunkIndex)` - выбор узлов для чанка
  - [ ] Распределение узлов равномерно
  - [ ] Учёт свободного места
- [ ] `SetProgressCallback(callback)` - настройка прогресса
- [ ] `ReportProgress(current, total)` - отчёт о прогрессе
- [ ] Логирование операций

**Критерии приёмки:**
- Параллельная загрузка работает (если реализована)
- Прогресс отображается
- Распределение узлов равномерное

---

### Задача 3.3: Реализация DownloadManager (часть 1 - базовое скачивание)
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/include/core/download_manager.h`
- `client/src/core/download_manager.cpp`

**Функциональность:**
- [ ] Конструктор с MetadataClient
- [ ] `DownloadFile(remoteFilename, localPath)` - главный метод скачивания
  - [ ] Запрос метаданных файла
  - [ ] Параллельное скачивание чанков
  - [ ] Проверка успешности скачивания
  - [ ] Сборка файла
- [ ] `DownloadChunk(chunkInfo, chunk)` - скачивание одного чанка
  - [ ] Попытка скачать с любого доступного узла
  - [ ] Отказоустойчивость (попытка с разных узлов)
- [ ] Обработка ошибок

**Критерии приёмки:**
- Скачивание файла работает
- Параллельное скачивание работает
- Отказоустойчивость работает

---

### Задача 3.4: Реализация DownloadManager (часть 2 - отказоустойчивость)
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `TryDownloadFromNodes(chunkId, nodeIds, chunk)` - попытка скачать с узлов
  - [ ] Перебор узлов по списку
  - [ ] Попытка скачать с каждого узла
  - [ ] Валидация скачанного чанка
  - [ ] Возврат при первой успешной попытке
- [ ] `GetNodeInfo(nodeId, metadata)` - получение информации об узле
- [ ] Ограничение количества параллельных потоков
- [ ] `SetProgressCallback(callback)` - настройка прогресса
- [ ] Логирование операций

**Критерии приёмки:**
- Отказоустойчивость работает
- При отказе одного узла используется другой
- Валидация чанков работает

---

## Этап 4: Главный класс Client и CLI

### Задача 4.1: Реализация Client (часть 1 - инициализация)
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/include/core/client.h`
- `client/src/core/client.cpp`

**Функциональность:**
- [ ] Конструктор и деструктор
- [ ] `Initialize(serverIp, port)` - инициализация клиента
  - [ ] Создание MetadataClient
  - [ ] Создание UploadManager и DownloadManager
  - [ ] Проверка подключения к Metadata Server
- [ ] `Shutdown()` - корректное завершение
- [ ] Геттеры для компонентов

**Критерии приёмки:**
- Инициализация работает
- Компоненты создаются правильно

---

### Задача 4.2: Реализация Client (часть 2 - обработка команд)
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `ExecuteCommand(args)` - выполнение команды
  - [ ] Парсинг команды
  - [ ] Маршрутизация к обработчику
  - [ ] Обработка ошибок
- [ ] `HandleUpload(args)` - обработка команды upload
  - [ ] Валидация аргументов
  - [ ] Вызов UploadManager::UploadFile
  - [ ] Обработка ошибок
- [ ] `HandleDownload(args)` - обработка команды download
  - [ ] Валидация аргументов
  - [ ] Вызов DownloadManager::DownloadFile
  - [ ] Обработка ошибок
- [ ] `HandleList()` - обработка команды list
- [ ] `HandleHelp()` - обработка команды help

**Критерии приёмки:**
- Все команды обрабатываются
- Валидация аргументов работает
- Обработка ошибок

---

### Задача 4.3: Реализация Client (часть 3 - утилиты)
**Приоритет:** Средний  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `PrintUsage()` - вывод справки
- [ ] `PrintError(message)` - вывод ошибки
- [ ] `PrintInfo(message)` - вывод информации
- [ ] `ValidateCommand(args)` - валидация команды
- [ ] `ExpandPath(path)` - расширение пути (опционально)

**Критерии приёмки:**
- Утилиты работают
- Вывод форматирован правильно

---

### Задача 4.4: Реализация main.cpp
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `client/src/main.cpp`

**Функциональность:**
- [ ] Парсинг аргументов командной строки:
  - [ ] `--server <ip>` - IP Metadata Server
  - [ ] `--port <port>` - порт Metadata Server
  - [ ] `--verbose` - подробный вывод
  - [ ] `--quiet` - минимальный вывод
- [ ] Парсинг команды и аргументов
- [ ] Создание экземпляра Client
- [ ] Инициализация клиента
- [ ] Выполнение команды
- [ ] Обработка ошибок
- [ ] Корректное завершение

**Критерии приёмки:**
- Клиент запускается из командной строки
- Параметры парсятся корректно
- Команды выполняются

---

## Этап 5: Интеграция и тестирование

### Задача 5.1: Интеграция всех компонентов
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Проверка работы всех компонентов вместе
- [ ] Тестирование полного цикла загрузки
- [ ] Тестирование полного цикла скачивания
- [ ] Проверка отсутствия утечек памяти
- [ ] Проверка корректного завершения

**Критерии приёмки:**
- Все компоненты работают вместе
- Нет утечек памяти
- Полные циклы работают

---

### Задача 5.2: Логирование и вывод
**Приоритет:** Средний  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Система логирования (консоль)
- [ ] Уровни вывода (verbose, normal, quiet)
- [ ] Логирование важных событий:
  - [ ] Подключение к серверам
  - [ ] Прогресс загрузки/скачивания
  - [ ] Ошибки
- [ ] Форматированный вывод

**Критерии приёмки:**
- Логирование работает
- Вывод информативен

---

### Задача 5.3: Обработка ошибок
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Обработка ошибок файловой системы
- [ ] Обработка сетевых ошибок
- [ ] Обработка ошибок протокола
- [ ] Повторные попытки при сбоях
- [ ] Понятные сообщения об ошибках пользователю
- [ ] Логирование всех ошибок

**Критерии приёмки:**
- Все ошибки обрабатываются
- Пользователь получает понятные сообщения
- Повторные попытки работают

---

### Задача 5.4: Валидация целостности
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Валидация каждого скачанного чанка
  - [ ] Проверка хеша
  - [ ] Проверка размера
- [ ] Проверка последовательности чанков при сборке
- [ ] Предупреждения при несовпадении хешей
- [ ] Опциональная проверка хеша всего файла

**Критерии приёмки:**
- Валидация работает
- Обнаруживаются повреждённые чанки
- Проверка последовательности работает

---

### Задача 5.5: Unit-тесты
**Приоритет:** Средний  
**Время:** 8 часов  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Тесты для ChunkProcessor
  - [ ] Разбиение файла
  - [ ] Сборка файла
  - [ ] Валидация чанков
- [ ] Тесты для MetadataClient
  - [ ] Парсинг ответов
  - [ ] Запросы к серверу (с моками)
- [ ] Тесты для NodeClient
  - [ ] Сохранение и получение чанков (с моками)
- [ ] Тесты для UploadManager (с моками)
- [ ] Тесты для DownloadManager (с моками)

**Критерии приёмки:**
- Основные функции покрыты тестами
- Тесты используют моки где необходимо
- Тесты проходят

---

### Задача 5.6: Интеграционное тестирование
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Тест полного цикла загрузки файла
- [ ] Тест полного цикла скачивания файла
- [ ] Тест обработки отказов узлов при скачивании
- [ ] Тест с большими файлами (>10 МБ)
- [ ] Тест параллельного скачивания
- [ ] Тест валидации целостности

**Критерии приёмки:**
- Все сценарии работают
- Система стабильна
- Нет утечек памяти

---

### Задача 5.7: Документация кода
**Приоритет:** Низкий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Комментарии к классам и методам
- [ ] Описание параметров
- [ ] Примеры использования
- [ ] README для client
- [ ] Описание команд CLI

**Критерии приёмки:**
- Код документирован
- Легко понять назначение компонентов

---

## Итоговая проверка

### Критерии готовности Client:

- [ ] Клиент запускается из командной строки
- [ ] Команда upload загружает файл в систему
- [ ] Команда download скачивает файл из системы
- [ ] Команда list показывает список файлов
- [ ] Параллельное скачивание работает
- [ ] Отказоустойчивость работает (при отказе узла используется другой)
- [ ] Валидация целостности чанков работает
- [ ] Прогресс операций отображается
- [ ] Обработка ошибок работает корректно
- [ ] Нет утечек памяти
- [ ] Работает на Windows и Linux

---

## Приоритизация задач

**Критический путь (необходимо для базовой работы):**
1. Задачи 1.1-1.4 (базовые компоненты)
2. Задачи 2.1-2.5 (взаимодействие с серверами)
3. Задачи 3.1, 3.3 (менеджеры загрузки и скачивания)
4. Задачи 4.1-4.2, 4.4 (Client и CLI)
5. Задача 5.1 (интеграция)

**Важные (для стабильной работы):**
- Задача 3.4 (отказоустойчивость)
- Задача 5.3 (обработка ошибок)
- Задача 5.4 (валидация целостности)
- Задача 5.6 (интеграционное тестирование)

**Желательные (для улучшения):**
- Задача 1.5 (прогресс)
- Задача 3.2 (оптимизации)
- Задача 5.2 (логирование)
- Задачи 5.5, 5.7 (тесты и документация)

---

## Заметки по реализации

1. **Платформо-независимость:** Использовать std::fstream для работы с файлами
2. **Параллелизм:** Использовать std::thread для параллельного скачивания
3. **Управление памятью:** Использовать умные указатели (unique_ptr, shared_ptr)
4. **Обработка ошибок:** Все ошибки должны логироваться и обрабатываться
5. **Протокол:** Строго следовать спецификации протокола из `05-network-protocol.md`
6. **Валидация:** Всегда валидировать скачанные чанки
7. **Тестирование:** Тестировать каждый компонент отдельно перед интеграцией
8. **Прогресс:** Отображать прогресс для длительных операций

---

## Особенности реализации

### Работа с файлами
- Использовать std::fstream для кроссплатформенности
- Буферизация для повышения производительности
- Обработка больших файлов (>1 ГБ)

### Параллелизм
- Ограничение количества параллельных потоков
- Потокобезопасность при работе с общими данными
- Правильное завершение потоков

### Отказоустойчивость
- Повторные попытки при сетевых ошибках
- Использование реплик при отказе узла
- Частичное восстановление при скачивании

### Валидация
- Проверка хеша каждого чанка
- Проверка последовательности при сборке
- Опциональная проверка хеша всего файла


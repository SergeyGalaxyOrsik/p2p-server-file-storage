# Задачи для реализации Metadata Server

## Общая информация

Этот документ содержит детальный список задач для реализации Metadata Server. Задачи разбиты на этапы и приоритизированы.

**Оценка времени:** ~2 недели (80 часов)

---

## Этап 1: Базовая инфраструктура и сетевой слой

### Задача 1.1: Настройка проекта
**Приоритет:** Высокий  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

- [ ] Создать структуру папок `metadata-server/src` и `metadata-server/include`
- [ ] Создать `CMakeLists.txt` для metadata-server
- [ ] Настроить зависимости (common library)
- [ ] Настроить компиляцию под Windows с WinAPI и Winsock

**Критерии приёмки:**
- Проект компилируется без ошибок
- Можно собрать пустой исполняемый файл

---

### Задача 1.2: Реализация сетевых утилит (NetworkUtils)
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `common/include/network_utils.h`
- `common/src/network_utils.cpp`

**Функциональность:**
- [ ] `InitializeWinsock()` - инициализация Winsock
- [ ] `CleanupWinsock()` - очистка Winsock
- [ ] `SendMessage(SOCKET, string)` - отправка текстового сообщения
- [ ] `ReceiveMessage(SOCKET, string&, size_t, int)` - приём текстового сообщения с таймаутом
- [ ] `SetSocketTimeout(SOCKET, int)` - установка таймаута сокета
- [ ] `GetClientIP(SOCKET)` - получение IP клиента
- [ ] `CloseSocket(SOCKET)` - корректное закрытие сокета

**Критерии приёмки:**
- Все функции работают корректно
- Обработка ошибок Winsock
- Тесты для основных функций

---

### Задача 1.3: Реализация основного класса MetadataServer
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Файлы:**
- `metadata-server/include/server.h`
- `metadata-server/src/server.cpp`
- `metadata-server/src/main.cpp`

**Функциональность:**
- [ ] Конструктор и деструктор
- [ ] `Initialize(int port)` - инициализация сервера
  - [ ] Инициализация Winsock
  - [ ] Создание слушающего сокета
  - [ ] Привязка к порту
  - [ ] Настройка listen()
- [ ] `Run()` - основной цикл работы
  - [ ] Цикл accept()
  - [ ] Создание потоков для клиентов
- [ ] `Shutdown()` - корректное завершение
  - [ ] Закрытие всех соединений
  - [ ] Остановка потоков
  - [ ] Очистка ресурсов
- [ ] `HandleClient(SOCKET)` - обработка клиента
- [ ] Обработка сигналов завершения (Ctrl+C)

**Критерии приёмки:**
- Сервер запускается и слушает порт
- Принимает соединения
- Корректно завершается

---

## Этап 2: Управление узлами (NodeManager)

### Задача 2.1: Структура данных StorageNode
**Приоритет:** Высокий  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `metadata-server/include/node_manager.h`

**Функциональность:**
- [ ] Определить структуру `StorageNode` со всеми полями
- [ ] Методы валидации данных узла

**Критерии приёмки:**
- Структура содержит все необходимые поля
- Валидация работает корректно

---

### Задача 2.2: Базовая функциональность NodeManager
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Файлы:**
- `metadata-server/include/node_manager.h`
- `metadata-server/src/node_manager.cpp`

**Функциональность:**
- [ ] Конструктор и деструктор
- [ ] `RegisterNode(ip, port, freeSpace, nodeId)` - регистрация узла
  - [ ] Валидация параметров
  - [ ] Генерация уникального nodeId
  - [ ] Сохранение в map с мьютексом
- [ ] `UnregisterNode(nodeId)` - удаление узла
- [ ] `GetNode(nodeId)` - получение узла по ID
- [ ] `UpdateNodeLastSeen(nodeId)` - обновление времени последнего контакта
- [ ] `UpdateNodeSpace(nodeId, freeSpace)` - обновление свободного места
- [ ] Потокобезопасность (мьютексы)

**Критерии приёмки:**
- Узлы регистрируются корректно
- Получение узлов работает
- Потокобезопасность обеспечена

---

### Задача 2.3: Алгоритм выбора узлов
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `GetAvailableNodes(count, requiredSpace)` - выбор узлов для загрузки
  - [ ] Фильтрация активных узлов
  - [ ] Проверка таймаута
  - [ ] Фильтрация по свободному месту
  - [ ] Сортировка по свободному месту
  - [ ] Выбор первых N узлов
- [ ] `GetAllActiveNodes()` - получение всех активных узлов
- [ ] `GetActiveNodeCount()` - количество активных узлов

**Критерии приёмки:**
- Алгоритм выбирает узлы корректно
- Учитывается свободное место
- Балансировка нагрузки

---

### Задача 2.4: Keep-Alive механизм
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `StartKeepAliveChecker()` - запуск потока проверки
- [ ] `StopKeepAliveChecker()` - остановка потока
- [ ] `CheckNodeHealth()` - проверка здоровья узлов
  - [ ] Проверка таймаута (60 секунд)
  - [ ] Помечание неактивных узлов
  - [ ] Удаление неактивных узлов (опционально)
- [ ] Поток работает в фоне каждые 30 секунд

**Критерии приёмки:**
- Неактивные узлы обнаруживаются
- Поток работает стабильно
- Корректная остановка потока

---

### Задача 2.5: Статистика NodeManager
**Приоритет:** Низкий  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `GetTotalNodes()` - общее количество узлов
- [ ] `GetActiveNodes()` - количество активных узлов
- [ ] `GetTotalFreeSpace()` - общее свободное место

**Критерии приёмки:**
- Статистика вычисляется корректно

---

## Этап 3: Управление метаданными (MetadataManager)

### Задача 3.1: Структуры данных для метаданных
**Приоритет:** Высокий  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `metadata-server/include/metadata_manager.h`

**Функциональность:**
- [ ] Определить структуру `ChunkInfo`
  - [ ] Поля: chunkId, index, size, nodeIds
  - [ ] Метод `IsValid()`
- [ ] Определить структуру `FileMetadata`
  - [ ] Поля: filename, totalSize, chunks, uploadTime
  - [ ] Метод `IsValid()`
  - [ ] Метод `GetChunkCount()`
  - [ ] Метод `HasChunk(chunkId)`

**Критерии приёмки:**
- Структуры определены корректно
- Валидация работает

---

### Задача 3.2: Базовая функциональность MetadataManager
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Файлы:**
- `metadata-server/include/metadata_manager.h`
- `metadata-server/src/metadata_manager.cpp`

**Функциональность:**
- [ ] Конструктор и деструктор
- [ ] `RegisterFile(filename, size, chunks)` - регистрация файла
  - [ ] Валидация метаданных
  - [ ] Санитизация имени файла
  - [ ] Сортировка чанков по index
  - [ ] Проверка целостности (последовательность индексов)
  - [ ] Сохранение в map с мьютексом
- [ ] `GetFileMetadata(filename)` - получение метаданных
- [ ] `DeleteFile(filename)` - удаление файла
- [ ] `FileExists(filename)` - проверка существования
- [ ] Потокобезопасность

**Критерии приёмки:**
- Файлы регистрируются корректно
- Получение метаданных работает
- Валидация работает

---

### Задача 3.3: Поиск и список файлов
**Приоритет:** Высокий  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `ListFiles()` - список имён файлов
- [ ] `GetAllFiles()` - все метаданные
- [ ] `GetFileChunks(filename)` - чанки файла
- [ ] `GetChunkInfo(filename, chunkId)` - информация о чанке

**Критерии приёмки:**
- Все методы работают корректно

---

### Задача 3.4: Статистика MetadataManager
**Приоритет:** Низкий  
**Время:** 2 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `GetFileCount()` - количество файлов
- [ ] `GetTotalBytes()` - общий объём данных
- [ ] Обновление статистики при изменениях

**Критерии приёмки:**
- Статистика вычисляется корректно

---

### Задача 3.5: Сохранение/загрузка метаданных (опционально)
**Приоритет:** Низкий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `SaveToFile(path)` - сохранение в JSON
  - [ ] Сериализация всех файлов
  - [ ] Запись в файл
- [ ] `LoadFromFile(path)` - загрузка из JSON
  - [ ] Парсинг JSON
  - [ ] Восстановление метаданных
  - [ ] Валидация загруженных данных
- [ ] Автосохранение при завершении сервера
- [ ] Автозагрузка при старте сервера

**Критерии приёмки:**
- Метаданные сохраняются и загружаются корректно
- Восстановление работает после перезапуска

---

## Этап 4: Обработка протокола (ProtocolHandler)

### Задача 4.1: Парсинг команд
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Файлы:**
- `metadata-server/include/protocol_handler.h`
- `metadata-server/src/protocol_handler.cpp`

**Функциональность:**
- [ ] `ParseCommand(string)` - разбор команды на токены
- [ ] `ReadMultilineRequest(SOCKET, string&)` - чтение многострочного запроса
- [ ] Обработка разделителей (\r\n)
- [ ] Валидация формата команд

**Критерии приёмки:**
- Парсинг работает корректно
- Обрабатываются все форматы команд

---

### Задача 4.2: Обработчики команд от Storage Node
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `HandleRegisterNode(args)` - обработка REGISTER_NODE
  - [ ] Парсинг параметров (ip, port, freeSpace)
  - [ ] Вызов NodeManager::RegisterNode
  - [ ] Формирование ответа
- [ ] `HandleKeepAlive(args)` - обработка KEEP_ALIVE
  - [ ] Парсинг nodeId
  - [ ] Обновление lastSeen
  - [ ] Формирование ответа
- [ ] `HandleUpdateSpace(args)` - обработка UPDATE_SPACE
  - [ ] Парсинг nodeId и freeSpace
  - [ ] Обновление свободного места
  - [ ] Формирование ответа

**Критерии приёмки:**
- Все команды обрабатываются корректно
- Ответы соответствуют протоколу
- Обработка ошибок

---

### Задача 4.3: Обработчики команд от Client (часть 1)
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `HandleRequestUpload(args)` - обработка REQUEST_UPLOAD
  - [ ] Парсинг filename и fileSize
  - [ ] Вычисление необходимого количества узлов (с учётом репликации)
  - [ ] Вызов NodeManager::GetAvailableNodes
  - [ ] Формирование ответа со списком узлов
- [ ] `HandleListFiles()` - обработка LIST_FILES
  - [ ] Получение списка файлов
  - [ ] Формирование ответа

**Критерии приёмки:**
- Команды обрабатываются корректно
- Ответы соответствуют протоколу

---

### Задача 4.4: Обработчики команд от Client (часть 2)
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `HandleUploadComplete(socket)` - обработка UPLOAD_COMPLETE
  - [ ] Чтение многострочного запроса
  - [ ] Парсинг filename
  - [ ] Парсинг списка чанков
  - [ ] Валидация данных чанков
  - [ ] Вызов MetadataManager::RegisterFile
  - [ ] Формирование ответа
- [ ] `HandleRequestDownload(args)` - обработка REQUEST_DOWNLOAD
  - [ ] Парсинг filename
  - [ ] Получение метаданных файла
  - [ ] Формирование ответа со списком чанков

**Критерии приёмки:**
- Многострочные запросы обрабатываются корректно
- Все данные парсятся правильно
- Ответы соответствуют протоколу

---

### Задача 4.5: Главный метод ProcessRequest
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] `ProcessRequest(request, socket)` - главный метод обработки
  - [ ] Определение типа команды
  - [ ] Маршрутизация к соответствующему обработчику
  - [ ] Обработка неизвестных команд
  - [ ] Формирование ответов об ошибках
- [ ] Утилиты для создания ответов
  - [ ] `CreateErrorResponse(errorCode, message)`
  - [ ] `CreateSuccessResponse(data)`

**Критерии приёмки:**
- Все команды обрабатываются
- Ошибки обрабатываются корректно
- Ответы формируются правильно

---

## Этап 5: Интеграция и тестирование

### Задача 5.1: Интеграция всех компонентов
**Приоритет:** Высокий  
**Время:** 4 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Подключение ProtocolHandler к MetadataServer
- [ ] Передача NodeManager и MetadataManager в ProtocolHandler
- [ ] Настройка обработки клиентов
- [ ] Проверка работы всех компонентов вместе

**Критерии приёмки:**
- Все компоненты работают вместе
- Нет утечек памяти
- Корректное завершение работы

---

### Задача 5.2: Логирование
**Приоритет:** Средний  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Система логирования (простая, в консоль или файл)
- [ ] Уровни логирования (INFO, WARNING, ERROR)
- [ ] Логирование важных событий:
  - [ ] Регистрация узлов
  - [ ] Загрузка/скачивание файлов
  - [ ] Ошибки
  - [ ] Таймауты узлов

**Критерии приёмки:**
- Логирование работает
- Логи информативны

---

### Задача 5.3: Обработка ошибок
**Приоритет:** Высокий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Обработка сетевых ошибок
- [ ] Обработка ошибок протокола
- [ ] Обработка ошибок бизнес-логики
- [ ] Корректные ответы об ошибках клиентам
- [ ] Логирование всех ошибок

**Критерии приёмки:**
- Все ошибки обрабатываются
- Клиенты получают понятные сообщения
- Сервер не падает при ошибках

---

### Задача 5.4: Unit-тесты
**Приоритет:** Средний  
**Время:** 8 часов  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Тесты для NodeManager
  - [ ] Регистрация узлов
  - [ ] Выбор узлов
  - [ ] Keep-alive
- [ ] Тесты для MetadataManager
  - [ ] Регистрация файлов
  - [ ] Поиск файлов
  - [ ] Валидация
- [ ] Тесты для ProtocolHandler
  - [ ] Парсинг команд
  - [ ] Обработка команд
  - [ ] Формирование ответов

**Критерии приёмки:**
- Все основные функции покрыты тестами
- Тесты проходят

---

### Задача 5.5: Интеграционное тестирование
**Приоритет:** Высокий  
**Время:** 6 часов  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Тест полного цикла регистрации узла
- [ ] Тест полного цикла загрузки файла
- [ ] Тест полного цикла скачивания файла
- [ ] Тест обработки отказов узлов
- [ ] Тест множественных одновременных соединений

**Критерии приёмки:**
- Все сценарии работают
- Система стабильна

---

### Задача 5.6: Документация кода
**Приоритет:** Низкий  
**Время:** 3 часа  
**Статус:** ⬜ Не начато

**Функциональность:**
- [ ] Комментарии к классам и методам
- [ ] Описание параметров
- [ ] Примеры использования
- [ ] README для metadata-server

**Критерии приёмки:**
- Код документирован
- Легко понять назначение компонентов

---

## Итоговая проверка

### Критерии готовности Metadata Server:

- [ ] Сервер запускается и слушает порт
- [ ] Узлы могут регистрироваться
- [ ] Keep-alive механизм работает
- [ ] Клиенты могут запросить узлы для загрузки
- [ ] Клиенты могут зарегистрировать загруженный файл
- [ ] Клиенты могут запросить метаданные для скачивания
- [ ] Клиенты могут получить список файлов
- [ ] Неактивные узлы обнаруживаются и удаляются
- [ ] Обработка ошибок работает корректно
- [ ] Нет утечек памяти
- [ ] Корректное завершение работы

---

## Приоритизация задач

**Критический путь (необходимо для базовой работы):**
1. Задачи 1.1-1.3 (инфраструктура)
2. Задачи 2.1-2.3 (NodeManager базовая функциональность)
3. Задачи 3.1-3.2 (MetadataManager базовая функциональность)
4. Задачи 4.1-4.4 (ProtocolHandler)
5. Задача 5.1 (интеграция)

**Важные (для стабильной работы):**
- Задача 2.4 (Keep-alive)
- Задача 5.3 (обработка ошибок)
- Задача 5.5 (интеграционное тестирование)

**Желательные (для улучшения):**
- Задача 3.5 (сохранение/загрузка)
- Задача 5.2 (логирование)
- Задача 5.4 (unit-тесты)
- Задача 5.6 (документация)

---

## Заметки по реализации

1. **Потокобезопасность:** Все операции с shared данными должны быть защищены мьютексами
2. **Управление памятью:** Использовать умные указатели где возможно
3. **Обработка ошибок:** Все ошибки должны логироваться и обрабатываться
4. **Протокол:** Строго следовать спецификации протокола из `05-network-protocol.md`
5. **Тестирование:** Тестировать каждый компонент отдельно перед интеграцией

